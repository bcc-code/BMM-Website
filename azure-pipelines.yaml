pool:
  vmImage: 'windows-2022'
  
variables:
  CSharpServerUrlIndex: 1
  fileServerUrl: 'https://int-bmm-files.brunstad.org/'
  serverUrlIndex: 1
  ##azureSubscription: 'ReplaceMe'

stages:
  - stage: BuildAndPackage
    displayName: 'Build and package'
    jobs:
      - template: 'template.build.yml'

  - stage: BuildDotnet
    dependsOn: BuildAndPackage
    displayName: 'BuildDotnet'
    jobs:
      - job: 'BuildDotnetJob'
        steps:
          - task: DownloadPipelineArtifact@2

          - task: CopyFiles@2
            displayName: 'Copy client files'
            inputs:
              sourceFolder: 'client'
              targetFolder: 'BMM.Website/wwwroot'

          - script: dotnet build --configuration Release
            displayName: 'dotnet build Release'
          - script: dotnet publish -o output/
          
          - publish: $(System.DefaultWorkingDirectory)
            artifact: WorkingDirectory
          - publish: $(System.DefaultWorkingDirectory)/output/
            artifact: WebApp
  
  - stage: DeployINT
    dependsOn: BuildDotnet
    displayName: 'DeployINT'
    jobs:
    - job: 'DeployJob'
      steps:
        - task: DownloadPipelineArtifact@2

        - task: AzureRmWebAppDeployment@3
          displayName: 'Deploy Client App Service'
          inputs:
            azureSubscription: '$(azureSubscription)'
            appType: 'Web App'
            WebAppName: 'INT-BMM'
            Package: '$(Pipeline.Workspace)/drop/client-*.zip'
            TakeAppOfflineFlag: true
            UseWebDeploy: true
            RemoveAdditionalFilesFlag: true
            ExcludeFilesFromAppDataFlag: true
            RenameFilesFlag: true
            JSONFiles: '/scripts/*.config.json'
            
        - task: AzureRmWebAppDeployment@3
          displayName: 'Deploy Admin App Service'
          inputs:
            azureSubscription: '$(azureSubscription)'
            appType: 'Web App'
            WebAppName: 'INT-BMM'
            VirtualApplication: /admin
            Package: '$(Pipeline.Workspace)/drop/admin-*.zip'
            TakeAppOfflineFlag: true
            UseWebDeploy: true
            RemoveAdditionalFilesFlag: true
            ExcludeFilesFromAppDataFlag: true
            RenameFilesFlag: true
            JSONFiles: '/scripts/*.config.json'